<html>
<head>
    <meta charset="utf-8" />
    <script src="wasm_exec.js"></script>
    <script>
        if (!WebAssembly.instantiateStreaming) {
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
                const source = await (await resp).arrayBuffer();
                return await WebAssembly.initiate(source, importObject);
            };
        }
        const go = new Go();
        WebAssembly
            .instantiateStreaming(fetch("libwbjs.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
            });
    </script>
</head>
    <body style="text-align-last: center">
        <form id="apiform" action="" >
            <label for="apikey">API key:</label>
            <input type="password" id="apikey" name="apikey" size="50" >
            <input type="submit"
                   onclick="wandbLogin(apikey.value)" />
        </form>

        <div>
            <input type="submit"
                   value="> Train <"
                   onclick="train()"/>
        </div>
        <br>
        <div id="frame"></div>
    </body>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
<script>
    let apiform = document.getElementById("apiform");

    apiform.addEventListener("submit", (e) => {
        e.preventDefault();
    });

    let wandbLogin = function(input) {
        console.log("login");
        wandb_login(input);
    }

    function Run(run_id, run_num, name, entity, project, url) {
        this.id = run_id;
        this.name = name;
        this.entity = entity;
        this.project = project;
        this.url = url;
        this._num = run_num;
        this.finish = function() {
            // console.log("fin1");
            let r = wandb_finish(this._num);
            // console.log("fin2");
            return r;
        };
        this.log_scaler = function(k, v) {
            wandb_log_scaler(this._num,k, v);
        };
        this.display = function() {
            var frame = document.getElementById("frame");
            let html = "<iframe src=\"_URL_\" style=\"border:none;width:100%;height:654;\"></iframe>";
            html = html.replace("_URL_", this.url);
            // console.log("frame", html);
            frame.innerHTML = html;
        };
    }

    async function wandbInit() {
        let run_promise = wandb_init();
        let run = run_promise;
        let fin = new Promise(function(resolve, reject) {
            run.then(function(result) {
                // console.log("got", result);
                let run_obj = JSON.parse(result.encoded);
                run = new Run(run_obj.id, run_obj._num, run_obj.name, run_obj.entity, run_obj.project, run_obj.url);
                resolve(run);
            });
        });

        // run = new Run(run_obj.id, run_obj._num);
        return fin;
    }

    function delay(time) {
        return new Promise(resolve => setTimeout(resolve, time));
    }

    async function train() {
        const model = tf.sequential();
        model.add(tf.layers.dense({units: 1, inputShape: [1]}));
        model.compile({
            loss: "meanSquaredError",
            metrics: ["accuracy"],
            optimizer: "sgd"});
        const xs = tf.tensor2d([-1, 0, 1, 2, 3, 4], [6, 1]);
        const ys = tf.tensor2d([-3, -1, 1, 3, 5, 7], [6, 1]);

        run = await wandbInit();
        console.log("RUN", run);
        run.display();

        function onBatchEnd(batch, logs) {
            // console.log("Accuracy", logs);
            run.log_scaler("loss", logs.loss);
        }

        await model.fit(xs, ys,
            {
                epochs: 20,
                callbacks: {onBatchEnd}
            });
        await run.finish();
    }

    async function train2() {
        run = await wandbInit();
        console.log("RUN", run);
        run.display();
        for (let i = 0; i < 20; i++) {
            console.log("log", i);
            run.log_scaler("acc", i);
            await delay(300);
        }
        await run.finish();
    }

</script>
</html>
