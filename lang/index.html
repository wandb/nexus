<html>
<head>
    <meta charset="utf-8" />
    <script src="wasm_exec.js"></script>
    <script>
        if (!WebAssembly.instantiateStreaming) {
            WebAssembly.instantiateStreaming = async (resp, importObject) => {
                const source = await (await resp).arrayBuffer();
                return await WebAssembly.initiate(source, importObject);
            };
        }
        const go = new Go();
        WebAssembly
            .instantiateStreaming(fetch("libwbjs.wasm"), go.importObject)
            .then((result) => {
                go.run(result.instance);
            });
    </script>
</head>
    <body style="text-align-last: center">
        <form id="apiform" action="" >
            <label for="apikey">API key:</label>
            <input type="password" id="apikey" name="apikey" size="50" >
            <input type="submit"
                   onclick="wandbLogin(apikey.value)" />
        </form>

        <div>
            <input type="submit"
                   value="> Train <"
                   onclick="train()"/>
        </div>
    </body>
<script>
    let apiform = document.getElementById("apiform");

    apiform.addEventListener("submit", (e) => {
        e.preventDefault();
    });

    let wandbLogin = function(input) {
        console.log("login");
        wandb_login(input);
    }

    function Run(run_id, run_num) {
        this.id = run_id;
        this._num = run_num;
        this.finish = function() {
            console.log("fin1");
            let r = wandb_finish(this._num);
            console.log("fin2");
            return r;
        };
        this.log_scaler = function(k, v) {
            wandb_log_scaler(this._num,k, v);
        };
    }

    async function wandbInit() {
        console.log("init");
        let run_promise = wandb_init();
        console.log("init2");
        let run = run_promise;
        console.log("init3", run);
        let fin = new Promise(function(resolve, reject) {
            run.then(function(result) {
                console.log("got", result);
                let run_obj = JSON.parse(result.encoded);
                run = new Run(run_obj.id, run_obj._num);
                resolve(run);
            });
        });

        // run = new Run(run_obj.id, run_obj._num);
        return fin;
    }

    async function train() {
        run = await wandbInit();
        console.log("RUN", run);
        for (let i = 0; i < 10; i++) {
            console.log("log", i);
            run.log_scaler("acc", i);
        }
        await run.finish();
    }
</script>
</html>
